---
import Base from '../../layouts/Base.astro';
import { getExperimentBySlug, type CopyPack } from '../../lib/api';

export const prerender = false;

const { slug } = Astro.params;

if (!slug) {
  return Astro.redirect('/404');
}

const experiment = await getExperimentBySlug(slug);

if (!experiment || !['launch', 'run'].includes(experiment.status)) {
  return Astro.redirect('/404');
}

let copyPack: CopyPack | null = null;
if (experiment.copy_pack) {
  try {
    copyPack = JSON.parse(experiment.copy_pack);
  } catch (e) {
    console.error('Failed to parse copy_pack:', e);
  }
}

const headline = copyPack?.headline || experiment.name;
const subheadline = copyPack?.subheadline || '';
const valueProps = copyPack?.value_props || [];
const ctaPrimary = copyPack?.cta_primary || 'Get Early Access';
const showCompany = copyPack?.show_company !== false; // Default true for B2B, set false for B2C

// Check if this is a priced experiment
const hasPricing = !!experiment.stripe_price_id && experiment.price_cents;
const priceDisplay = hasPricing ? `$${(experiment.price_cents! / 100).toFixed(2)}` : null;
---

<Base title={`${experiment.name} | Silicon Crane`} description={subheadline || 'Join the waitlist'}>
  <main class="container mx-auto px-4 py-16">
    <div class="max-w-2xl mx-auto">
      <!-- Header -->
      <div class="text-center mb-12">
        <h1 class="text-4xl md:text-5xl font-bold mb-4">{headline}</h1>
        {subheadline && (
          <p class="text-xl text-gray-600">{subheadline}</p>
        )}
        {hasPricing && (
          <div class="mt-4">
            <span class="inline-block bg-blue-100 text-blue-800 text-2xl font-bold px-6 py-3 rounded-lg">
              {priceDisplay}
            </span>
          </div>
        )}
      </div>

      <!-- Value Props -->
      {valueProps.length > 0 && (
        <div class="mb-12">
          <ul class="space-y-4">
            {valueProps.map((prop) => (
              <li class="flex items-start">
                <svg class="w-6 h-6 text-green-500 mr-3 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span class="text-lg text-gray-700">{prop}</span>
              </li>
            ))}
          </ul>
        </div>
      )}

      <!-- Payment CTA for Priced Experiments -->
      {hasPricing ? (
        <div class="bg-gray-50 rounded-lg p-8 shadow-md text-center">
          <h2 class="text-2xl font-semibold mb-4">{ctaPrimary}</h2>
          <p class="text-gray-600 mb-6">
            Secure your spot with a one-time payment of <strong>{priceDisplay}</strong>
          </p>
          <a
            href={`/e/${slug}/payment`}
            class="inline-block w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors"
          >
            Proceed to Payment
          </a>
          <p class="text-xs text-gray-500 mt-4">
            Powered by Stripe â€¢ Secure payment processing
          </p>
        </div>
      ) : (
        <!-- Lead Capture Form for Free Experiments -->
        <div class="bg-gray-50 rounded-lg p-8 shadow-md">
          <h2 class="text-2xl font-semibold mb-6">{ctaPrimary}</h2>

        <div id="form-message" class="hidden mb-4 p-4 rounded-lg"></div>

        <form id="lead-form" class="space-y-4">
          <!-- Email (required) -->
          <div>
            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">
              Email *
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="you@example.com"
            />
          </div>

          <!-- Name (optional) -->
          <div>
            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">
              Name
            </label>
            <input
              type="text"
              id="name"
              name="name"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
              placeholder="Your name"
            />
          </div>

          <!-- Company (optional, B2B only) -->
          {showCompany && (
            <div>
              <label for="company" class="block text-sm font-medium text-gray-700 mb-1">
                Company
              </label>
              <input
                type="text"
                id="company"
                name="company"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                placeholder="Your company"
              />
            </div>
          )}

          <!-- Honeypot field (hidden from humans) -->
          <div style="position: absolute; left: -9999px;" aria-hidden="true">
            <label for="website">Website (leave blank)</label>
            <input type="text" id="website" name="website" tabindex="-1" autocomplete="off" />
          </div>

          <!-- Submit Button -->
          <button
            type="submit"
            id="submit-btn"
            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            {ctaPrimary}
          </button>
        </form>
        </div>
      )}
    </div>
  </main>

  <script define:vars={{ experimentId: experiment.id, slug, apiUrl: 'https://sc-api.automation-ab6.workers.dev' }}>
    // Generate session and visitor IDs
    function getOrCreateId(key, expiryDays) {
      let id = localStorage.getItem(key);
      if (!id) {
        id = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem(key, id);
      }
      return id;
    }

    const sessionId = getOrCreateId('sc_session_id', 1);
    const visitorId = getOrCreateId('sc_visitor_id', 365);

    // Extract UTM parameters from URL
    const urlParams = new URLSearchParams(window.location.search);
    const utmParams = {
      utm_source: urlParams.get('utm_source'),
      utm_medium: urlParams.get('utm_medium'),
      utm_campaign: urlParams.get('utm_campaign'),
      utm_term: urlParams.get('utm_term'),
      utm_content: urlParams.get('utm_content'),
    };

    // Handle form submission
    const form = document.getElementById('lead-form');
    const submitBtn = document.getElementById('submit-btn');
    const messageDiv = document.getElementById('form-message');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Check honeypot
      const website = document.getElementById('website').value;
      if (website) {
        // Likely a bot, silently ignore
        window.location.href = `/e/${slug}/thank-you`;
        return;
      }

      // Disable submit button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Submitting...';

      // Get form data
      const formData = new FormData(form);
      const email = formData.get('email');
      const name = formData.get('name');
      const company = formData.get('company');

      // Build request payload
      const payload = {
        experiment_id: experimentId,
        email,
        name: name || undefined,
        company: company || undefined,
        session_id: sessionId,
        visitor_id: visitorId,
        ...Object.fromEntries(
          Object.entries(utmParams).filter(([_, v]) => v !== null)
        ),
      };

      try {
        const response = await fetch(`${apiUrl}/leads`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(payload),
        });

        const result = await response.json();

        if (result.success) {
          // Success - redirect to thank you page
          window.location.href = `/e/${slug}/thank-you`;
        } else {
          // Handle API errors
          const errorCode = result.error?.code || 'UNKNOWN_ERROR';

          if (errorCode === 'DUPLICATE_LEAD') {
            messageDiv.className = 'mb-4 p-4 rounded-lg bg-yellow-50 text-yellow-800 border border-yellow-200';
            messageDiv.textContent = "You're already on the list! Check your email for updates.";
          } else {
            messageDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 text-red-800 border border-red-200';
            messageDiv.textContent = result.error?.message || 'Something went wrong. Please try again.';
          }

          messageDiv.classList.remove('hidden');
          submitBtn.disabled = false;
          submitBtn.textContent = formData.get('cta') || 'Get Early Access';
        }
      } catch (error) {
        messageDiv.className = 'mb-4 p-4 rounded-lg bg-red-50 text-red-800 border border-red-200';
        messageDiv.textContent = 'Network error. Please check your connection and try again.';
        messageDiv.classList.remove('hidden');

        submitBtn.disabled = false;
        submitBtn.textContent = formData.get('cta') || 'Get Early Access';
      }
    });
  </script>
</Base>
